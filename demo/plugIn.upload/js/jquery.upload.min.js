(function($){
	$.fn.upload = function(options){

		var defaluts = {
			"url":"whj.fayfox.com/upload/",	//必填
			"callback" : null
		},

		options = $.extend(defaluts, options),

		objs = {
			bars : $("<div>").addClass("m_fileBar"),
			imgBar : $("<div>").addClass("m_fileImgBar").html("请添加上传文件"),
			btnBar : $("<div>").addClass("m_fileBtnBar"),
			txtVal : $("<span>").addClass("u_fileTxtVal"),
			upBtn : $("<button type=\"button\">").addClass("u_fileBtnUp").html("浏览"),
			delBtn : $("<button type=\"button\">").addClass("u_fileBtnDel").html("删除")
		},

		domName = $(this),

		dfunc = {

			init : function(op,objs){

				var _t = this;

				_t.M.getHtml(op,objs);
				objs.txtVal.html(domName.val());

				objs.upBtn.click(function(){
					domName.click();
					
				});
				//file 开始改变
				domName.change(function(){
					objs.txtVal.html(domName.val());
					dfunc.C.getAjax(op.url,op.callback,objs.imgBar);
				});
			},

			//model
			M : {

				getHtml : function(op, objs){
					objs.bars.append(objs.imgBar);
					objs.bars.append(objs.btnBar);
					objs.btnBar.append(objs.txtVal);
					objs.btnBar.append(objs.upBtn);
					domName.parent().html(objs.bars);
					
					objs.btnBar.append(domName);

					domName.addClass("m_fileInp");
				}
			},

			//controller
			C : {

				//loading
				countDown : function(site,time){ //site=目标 $("") , time=总时间 60

					function t(time) {
						if(time < 100){

							site.html("图片上传中 " + time + "% ...");
								time ++;
								setTimeout(function(){
								t(time);
							},300);
						}
					}

					t(time);
				},

				//ajax
				getAjax : function(url,callback,site){

					var _t = this;
					_t.countDown(site,0);

					$.ajax({

						type : "post",
						url : url,
						dataType : "json",
						cache : false,
						success : function(res){
							_t.countDown(site,100);
							if(callback){
								callback();
							}
						}
					})
				}

			}
		};

		dfunc.init(options,objs);

	};

})(jQuery);